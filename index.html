<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ì»¤í”¼í˜• ì¸ê°„ì…ë‹ˆë‹¤ â€” ë³¸ì¸ì˜ í˜ˆì•¡ ì† ì»¤í”¼ ìœ ì „ìë¥¼ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.</title>

  <!-- ê²°ê³¼ ì¹´ë“œ ìº¡ì³ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Leaflet (ì§€ë„) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      /* ëª¨ë˜ & ë¯¸ë‹ˆë©€ ì»¤í”¼ íŒ”ë ˆíŠ¸ */
      --bg:#f4eee6;
      --card:#ffffff;
      --muted:#8a7660;
      --coffee-dark:#7a4f32;   /* ë©”ì¸ ë¸Œë¼ìš´ */
      --coffee-mid:#e3c9a4;    /* ë¼ì´íŠ¸ ë¸Œë¼ìš´ */
      --tap:44px;
      --radius:14px;
      --shadow:0 6px 20px rgba(0,0,0,0.05);

      --ink:#2e1e0f;
      --card-bg:#fffdf7;
      --line:rgba(0,0,0,0.12);
      --accent:#c59663;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:"Noto Sans KR",system-ui,-apple-system;
      background:var(--bg);
      color:var(--coffee-dark);
      padding:max(16px, env(safe-area-inset-top))
              max(16px, env(safe-area-inset-right))
              max(24px, env(safe-area-inset-bottom))
              max(16px, env(safe-area-inset-left));
      line-height:1.45;
    }

    .wrap{
      max-width:880px;
      margin:0 auto;
      padding:24px;
      background:linear-gradient(180deg,rgba(255,255,255,0.65),rgba(255,255,255,0.9));
      border-radius:var(--radius);
    }

    /* ê³µí†µ í—¤ë” */
    header{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:10px;
    }
    header img{
      width:64px;
      height:64px;
      border-radius:12px;
      object-fit:cover;
      box-shadow:0 4px 14px rgba(0,0,0,0.06);
    }
    h1{font-size:22px}
    p.lead{margin-top:4px;color:var(--muted);font-size:14px}

    button{
      background:var(--coffee-dark);
      border:none;
      color:white;
      padding:12px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:14px;
      box-shadow:0 6px 14px rgba(0,0,0,0.12);
      transition:transform .08s ease, box-shadow .08s ease, background-color .12s ease, color .12s ease;
    }
    button:active{
      transform:translateY(1px);
      box-shadow:0 3px 8px rgba(0,0,0,0.18);
    }

    /* ===== í™”ë©´ ì „í™˜ìš© ===== */
    .screen{display:none;}
    .screen.active{display:block;}

    /* ë©”ì¸ ë©”ë‰´ */
    .menu-card{
      margin-top:18px;
      background:var(--card);
      border-radius:16px;
      padding:18px 16px 20px;
      box-shadow:var(--shadow);
      text-align:center;
    }
    .menu-title{
      font-size:18px;
      font-weight:800;
      margin-bottom:6px;
    }
    .menu-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:16px;
    }
    .menu-buttons{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:6px;
    }
    .menu-btn-main{
      background:var(--coffee-dark);
      color:#fff;
    }
    .menu-btn-sub{
      background:var(--coffee-mid);
      color:var(--ink);
      box-shadow:0 8px 16px rgba(0,0,0,0.06);
    }
    .menu-btn-ghost{
      background:var(--card-bg);
      color:var(--coffee-dark);
      border:1px solid var(--line);
      box-shadow:none;
    }

    /* ì„¤ë¬¸ ì¹´ë“œ */
    .card{
      background:var(--card);
      padding:16px;
      border-radius:12px;
      margin-top:16px;
      box-shadow:var(--shadow);
    }
    .question{margin-bottom:18px}
    .q-title{font-weight:800;font-size:15px;margin-bottom:8px}

    .likert-row{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
    }
    .likert{
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .likert-option{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      flex:1;
      min-width:0;
    }
    .edge-label{
      font-size:11px;
      font-weight:700;
      color:var(--coffee-dark);
      white-space:nowrap;
    }
    .dot{
      width:var(--tap);
      height:var(--tap);
      border-radius:50%;
      border:3px solid rgba(122,79,50,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .18s;
      background:#fff;
    }
    .likert small{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .likert input{display:none}
    .likert input:checked + .dot{
      background:var(--coffee-mid);
      border-color:var(--coffee-mid);
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }
    .likert input:checked + .dot small{color:#fff}

    .actions{text-align:right;margin-top:8px}
    .status{margin-top:6px;font-size:13px;color:var(--muted)}

    /* ===== ê²°ê³¼ ì¹´ë“œ ===== */
    .result-wrap{
      display:none;
      justify-content:center;
      margin-top:24px;
      margin-bottom:12px;
    }
    .result-container{
      width:100%;
      max-width:420px;
      display:flex;
      justify-content:center;
    }
    .result-card{
      width:100%;
      max-width:420px;
      height:auto;
      background:var(--card-bg);
      border-radius:16px;
      border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
      padding:16px 16px 22px;
      display:flex;
      flex-direction:column;
      color:var(--ink);
      overflow:visible;
    }

    .report-header{
      display:flex;
      align-items:center;
      gap:10px;
      padding-bottom:8px;
      border-bottom:1px solid var(--line);
    }
    .brand-logo{
      width:42px;
      height:auto;
      flex-shrink:0;
    }
    .report-head-text{
      font-size:10px;
      letter-spacing:.02em;
      color:rgba(0,0,0,0.55);
    }
    .report-head-title{
      font-weight:700;
      font-size:13px;
    }

    .main-box{
      margin-top:10px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.9);
    }
    .main-box h1{
      font-size:18px;
      margin-bottom:4px;
    }
    .subject{
      font-size:12px;
      margin-bottom:2px;
    }
    .type-line{
      font-size:13px;
      margin-bottom:6px;
    }
    .type-line strong{color:var(--accent);}
    .type-desc{
      font-size:11px;
      line-height:1.5;
      color:rgba(0,0,0,0.78);
    }

    .cafe-box{
      margin-top:8px;
      padding:10px 12px;
      border-radius:10px;
      border:1px dashed var(--accent);
      background:rgba(255,250,240,0.9);
      text-align:center;
      flex-shrink:0;
    }
    .cafe-label{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(0,0,0,0.55);
      margin-bottom:4px;
    }
    .cafe-name{
      min-height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      font-weight:800;
      color:var(--ink);
      margin-bottom:2px;
      text-align:center;
    }
    .cafe-note{
      font-size:11px;
      color:rgba(0,0,0,0.7);
    }

    .profile-box{
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.9);
      flex-shrink:0;
    }
    .profile-box h2{
      font-size:12px;
      margin-bottom:4px;
    }
    .profile-row{
      display:flex;
      align-items:center;
      font-size:11px;
      margin-bottom:3px;
    }
    .profile-row:last-child{margin-bottom:0}
    .profile-label{
      width:54px;
      font-weight:600;
    }
    .profile-dots{
      width:64px;
      font-family:monospace;
      font-size:11px;
    }
    .profile-text{
      flex:1;
      color:rgba(0,0,0,0.8);
    }

    .note-box{
      margin-top:6px;
      padding:8px 9px;
      border-radius:8px;
      border:1px solid var(--line);
      background:rgba(250,248,244,0.95);
      flex:1;
      display:flex;
      flex-direction:column;
    }
    .note-box h2{
      font-size:12px;
      margin-bottom:4px;
    }
    .note-box p{
      font-size:11px;
      line-height:1.5;
      color:rgba(0,0,0,0.82);
    }

    .top3-box{
      margin-top:6px;
      padding:8px 9px;
      border-radius:8px;
      border:1px dashed var(--line);
      background:rgba(255,255,255,0.9);
      font-size:11px;
      display:none;
    }
    .top3-box h3{
      font-size:11px;
      margin-bottom:4px;
    }
    .top3-box ul{
      margin-left:16px;
      margin-top:2px;
    }
    .top3-box li{
      margin-bottom:2px;
    }

    .report-footer{
      margin-top:14px;
      font-size:10px;
      text-align:center;
      color:rgba(0,0,0,0.55);
    }

    .result-actions{
      display:none;
      max-width:420px;
      margin:10px auto 0;
      flex-direction:column;
      gap:6px;
    }
    .result-actions button{
      width:100%;
      font-size:12px;
      border-radius:10px;
      padding:9px 8px;
      white-space:nowrap;
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
    }
    #toggleTop3Btn{background:var(--coffee-mid);color:var(--ink);}
    #saveImageBtn{background:var(--coffee-dark);}
    #retryBtn{background:#d9b48a;}

    /* ì§€ë„ í™”ë©´ */
    .map-card{
      margin-top:18px;
      background:var(--card);
      border-radius:16px;
      padding:14px 14px 18px;
      box-shadow:var(--shadow);
    }
    .map-title{
      font-size:18px;
      font-weight:800;
      margin-bottom:4px;
    }
    .map-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:10px;
    }
    #knuMap{
      width:100%;
      border-radius:12px;
      overflow:hidden;
      aspect-ratio:1/1; /* ì§€ì›ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ìš°ì„  ì •ì‚¬ê°í˜• ìœ ì§€ */
    }
    .map-legend{
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
    }
    .legend-row{
      display:flex;
      align-items:center;
      gap:6px;
      margin-top:2px;
    }
    .legend-dot{
      width:10px;
      height:10px;
      border-radius:50%;
    }

    /* ì•„ì£¼ ì‘ì€ í™”ë©´ìš© */
    @media (max-width:360px){
      :root{ --tap:38px; }
      .likert{gap:6px;}
      .likert-option{gap:3px;}
      .result-card{padding:12px 12px 18px;}
      .main-box h1{font-size:17px;}
    }

    @media (max-width:560px){
      header{align-items:flex-start}
      button{width:100%}
      .result-card{border-radius:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ê³µí†µ í—¤ë” -->
    <header>
      <img src="./logo.PNG" alt="ì»¤í”¼ ë¡œê³ ">
      <div>
        <h1>ì»¤í”¼í˜• ì¸ê°„ì…ë‹ˆë‹¤.</h1>
        <p class="lead">ë³¸ì¸ì˜ í˜ˆì•¡ ì† ì»¤í”¼ ìœ ì „ìë¥¼ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.</p>
      </div>
    </header>

    <!-- ===== 1. ë©”ì¸ ë©”ë‰´ í™”ë©´ ===== -->
    <section id="menuScreen" class="screen active">
      <div class="menu-card">
        <div class="menu-title">ì˜¤ëŠ˜ì˜ ì•„ì´ìŠ¤ ì•„ë©”ë¦¬ì¹´ë…¸, ê³¨ë¼ë³¼ê¹Œìš”?</div>
        <p class="menu-sub">
          ì·¨í–¥ í…ŒìŠ¤íŠ¸ë¡œ ë‚˜ë§Œì˜ ì»¤í”¼í˜•ì„ ì°¾ê³ ,<br>
          ê²½ë¶ëŒ€ ì¸ê·¼ ì•„ì•„ ì§€ë„ë¡œ ì° ë§›ì§‘ì„ í•¨ê»˜ ëª¨ìë‹ˆë‹¤.
        </p>
        <div class="menu-buttons">
          <button class="menu-btn-main" onclick="showScreen('test')">
            â˜• ë‚˜ì—ê²Œ ë§ëŠ” ì•„ì´ìŠ¤ ì•„ë©”ë¦¬ì¹´ë…¸ í…ŒìŠ¤íŠ¸í•˜ê¸°
          </button>
          <button class="menu-btn-sub" onclick="window.location.href='https://naver.me/FfBQjw53';">
            ğŸ§Š í•¨ê»˜ ê²½ë¶ëŒ€ ì•„ì•„ ì§€ë„ ë§Œë“¤ê¸°
          </button>
          <button class="menu-btn-ghost" onclick="showScreen('map')">
            ğŸ—º ê²½ë¶ëŒ€ ì•„ì•„ ì§€ë„(ê°œë°œì¤‘) ë¯¸ë¦¬ë³´ê¸°
          </button>
        </div>
      </div>
    </section>

    <!-- ===== 2. í…ŒìŠ¤íŠ¸ í™”ë©´ ===== -->
    <section id="testScreen" class="screen">
      <!-- ì„¤ë¬¸ ì¹´ë“œ -->
      <div class="card">
        <div class="question">
          <div class="q-title">1) ìƒí¼í•¨(ì‚°ë¯¸, ì‹ ë§›)</div>
          <div class="likert-row">
            <div class="likert">
              <label class="likert-option">
                <span class="edge-label">ì¢‹ì•„í•¨</span>
                <input type="radio" name="sour" value="4">
                <div class="dot"><small>ë§¤ìš°</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="sour" value="3">
                <div class="dot"><small>ì•½ê°„</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="sour" value="2">
                <div class="dot"><small>ë³„ë¡œ</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">ì‹«ì–´í•¨</span>
                <input type="radio" name="sour" value="1">
                <div class="dot"><small>ì „í˜€</small></div>
              </label>
            </div>
          </div>
        </div>

        <div class="question">
          <div class="q-title">2) ê³ ì†Œí•¨</div>
          <div class="likert-row">
            <div class="likert">
              <label class="likert-option">
                <span class="edge-label">ì¢‹ì•„í•¨</span>
                <input type="radio" name="nutty" value="4">
                <div class="dot"><small>ë§¤ìš°</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="nutty" value="3">
                <div class="dot"><small>ì•½ê°„</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="nutty" value="2">
                <div class="dot"><small>ë³„ë¡œ</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">ì‹«ì–´í•¨</span>
                <input type="radio" name="nutty" value="1">
                <div class="dot"><small>ì „í˜€</small></div>
              </label>
            </div>
          </div>
        </div>

        <div class="question">
          <div class="q-title">3) ìŒ‰ì‚¬ë¦„í•¨(ì“´ë§›)</div>
          <div class="likert-row">
            <div class="likert">
              <label class="likert-option">
                <span class="edge-label">ì¢‹ì•„í•¨</span>
                <input type="radio" name="bitter" value="4">
                <div class="dot"><small>ë§¤ìš°</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="bitter" value="3">
                <div class="dot"><small>ì•½ê°„</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="bitter" value="2">
                <div class="dot"><small>ë³„ë¡œ</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">ì‹«ì–´í•¨</span>
                <input type="radio" name="bitter" value="1">
                <div class="dot"><small>ì „í˜€</small></div>
              </label>
            </div>
          </div>
        </div>

        <div id="status" class="status">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>

        <div class="actions">
          <button onclick="calcResult()">ê²°ê³¼ ë³´ê¸°</button>
        </div>
      </div>

      <!-- ê²°ê³¼ ì¹´ë“œ -->
      <div class="result-wrap" id="resultWrap">
        <div class="result-container">
          <div class="result-card" id="resultCard">
            <header class="report-header">
              <img src="./logo.PNG" alt="ì»¤í”¼ ë¡œê³ " class="brand-logo">
              <div>
                <div class="report-head-text">í”„ë¡œì íŠ¸ ì»¤í”¼í˜• ì¸ê°„ì…ë‹ˆë‹¤.</div>
                <div class="report-head-title">ì»¤í”¼ ìœ ì „ì ê²€ì‚¬ ê²°ê³¼ì„œ</div>
              </div>
            </header>

            <section class="main-box">
              <h1>ì»¤í”¼í˜• ì¸ê°„ì…ë‹ˆë‹¤.</h1>
              <p class="subject">ê²€ì‚¬ ëŒ€ìƒ: <span>ì»¤í”¼ ìœ ì „ì ë³´ìœ ì</span>ë‹˜</p>
              <p class="type-line">ê²€ì‚¬ ê²°ê³¼ ìœ í˜•: <strong id="resultType">ìƒí¼í˜•</strong></p>
              <p class="type-desc" id="typeDesc">
                ìƒí¼í•œ ì‚°ë¯¸ì™€ ë°ì€ í–¥ì„ ì‚¬ë‘í•˜ëŠ”,
                ìƒˆë¡œì›€ì— ëŒë¦¬ëŠ” ì»¤í”¼í˜• ì¸ê°„ì…ë‹ˆë‹¤.
              </p>
            </section>

            <section class="cafe-box">
              <div class="cafe-label">RECOMMENDED CAFE</div>
              <div class="cafe-name" id="bestCafeName"></div>
              <p class="cafe-note">
                í˜„ì¬ê¹Œì§€ ìˆ˜ì§‘ëœ ì»¤í”¼ ë°ì´í„° ê¸°ì¤€,  
                ë‹¹ì‹ ì˜ ì·¨í–¥ê³¼ ê°€ì¥ ì˜ ë§ëŠ” ì¹´í˜ì…ë‹ˆë‹¤.
              </p>
            </section>

            <section class="profile-box">
              <h2>ë§› í”„ë¡œíŒŒì¼</h2>
              <div class="profile-row">
                <div class="profile-label">ìƒí¼í•¨</div>
                <div class="profile-dots" id="dotAcid"></div>
                <div class="profile-text" id="txtAcid"></div>
              </div>
              <div class="profile-row">
                <div class="profile-label">ê³ ì†Œí•¨</div>
                <div class="profile-dots" id="dotNutty"></div>
                <div class="profile-text" id="txtNutty"></div>
              </div>
              <div class="profile-row">
                <div class="profile-label">ìŒ‰ì‚¬ë¦„</div>
                <div class="profile-dots" id="dotBitter"></div>
                <div class="profile-text" id="txtBitter"></div>
              </div>
            </section>

            <section class="note-box">
              <h2>í•´ì„ ë©”ëª¨</h2>
              <p id="noteText"></p>
            </section>

            <section class="top3-box" id="top3Box">
              <h3>ë¹„ìŠ·í•œ ì»¤í”¼ TOP3</h3>
              <ul id="top3List"></ul>
            </section>

            <div class="report-footer">
              ë³¸ ê²°ê³¼ëŠ” â€˜ì»¤í”¼í˜• ì¸ê°„ì…ë‹ˆë‹¤.â€™ í”„ë¡œì íŠ¸ì˜ ì·¨í–¥ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‚°ì¶œëœ ë¹„ê³µì‹ ê²€ì‚¬ì…ë‹ˆë‹¤.<br>
              ì»¤í”¼í˜• ì¸ê°„ì…ë‹ˆë‹¤. Â· coffeeperson.co.kr
            </div>
          </div>
        </div>
      </div>

      <!-- ê²°ê³¼ í•˜ë‹¨ ë²„íŠ¼ë“¤ -->
      <div class="result-actions" id="resultActions">
        <button id="toggleTop3Btn">â˜• ë¹„ìŠ·í•œ ì»¤í”¼ TOP3 ë³´ê¸°</button>
        <button id="saveImageBtn">ğŸ“± ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥í•˜ê¸°</button>
        <button id="retryBtn" onclick="retry()">ğŸ”„ ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸°</button>
        <button class="menu-btn-ghost" onclick="showScreen('menu')">â† ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    </section>

    <!-- ===== 3. ê²½ë¶ëŒ€ ì•„ì•„ ì§€ë„ í™”ë©´ ===== -->
    <section id="mapScreen" class="screen">
      <div class="map-card">
        <div class="map-title">ê²½ë¶ëŒ€ ì•„ì´ìŠ¤ ì•„ë©”ë¦¬ì¹´ë…¸ ì§€ë„(ê°œë°œì¤‘)</div>
        <p class="map-sub">
          ê²½ë¶ëŒ€ ì¸ê·¼ì—ì„œ ì•„ì•„ë¥¼ íŒë§¤í•˜ëŠ” ì¹´í˜ë“¤ì„ í•˜ë‚˜ì”© ëª¨ìœ¼ëŠ” ì¤‘ì…ë‹ˆë‹¤.<br>
          ì  ìƒ‰ê¹”ì€ ì¹´í˜ì˜ ëŒ€í‘œ ì•„ì•„ ë§› íƒ€ì…ì„ ì˜ë¯¸í•´ìš”.
        </p>
        <div id="knuMap"></div>
        <div class="map-legend">
          <div class="legend-row">
            <div class="legend-dot" style="background:#f39c12;"></div> ìƒí¼í˜•
          </div>
          <div class="legend-row">
            <div class="legend-dot" style="background:#a67c52;"></div> ê³ ì†Œí˜•
          </div>
          <div class="legend-row">
            <div class="legend-dot" style="background:#6b3e26;"></div> ìŒ‰ì‚¬ë¦„í˜•
          </div>
          <div class="legend-row">
            <div class="legend-dot" style="background:#d35400;"></div> ë³µí•© ìƒí¼ê³ ì†Œí˜• / ë¸”ë Œë“œí˜•
          </div>
        </div>
        <div style="margin-top:10px;text-align:right;">
          <button class="menu-btn-ghost" onclick="showScreen('menu')">â† ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      </div>
    </section>

  </div>

  <script>
    /* ===== ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ í•­ìƒ ì •ì‚¬ê°í˜•ìœ¼ë¡œ ===== */
    function resizeKnuMapSquare(){
      const el = document.getElementById('knuMap');
      if(!el) return;
      const width = el.offsetWidth;
      el.style.height = width + 'px';
      if(window.knuMap){
        window.knuMap.invalidateSize();
      }
    }
    window.addEventListener('resize', resizeKnuMapSquare);

    /* ===== í™”ë©´ ì „í™˜ ===== */
    function showScreen(name){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      if(name === 'menu'){
        document.getElementById('menuScreen').classList.add('active');
        window.scrollTo({top:0,behavior:'smooth'});
      }else if(name === 'test'){
        document.getElementById('testScreen').classList.add('active');
        window.scrollTo({top:0,behavior:'smooth'});
      }else if(name === 'map'){
        document.getElementById('mapScreen').classList.add('active');
        // ì •ì‚¬ê°í˜•ìœ¼ë¡œ ë§ì¶˜ ë’¤ ì§€ë„ ì´ˆê¸°í™”
        setTimeout(()=>{
          resizeKnuMapSquare();
          initKnuMap();
        },0);
      }
    }

    /* ===== ë°ì´í„° ë¡œë”© ===== */
    const JSON_URL = './coffee-data.json?v=10';
    const CAFE_JSON_URL = './knu-cafes.json?v=1';

    let coffeeList = [];
    let knuCafes = [];
    let lastFetched = null;
    const statusEl = document.getElementById('status');

    async function fetchCoffeeData(){
      try{
        const res = await fetch(JSON_URL,{cache:'no-store'});
        const list = await res.json();
        coffeeList = list;
        lastFetched = new Date();
        statusEl.textContent = `ë“±ë¡ëœ ê²½ë¶ëŒ€ ì¸ê·¼ ì¹´í˜ ë°ì´í„° ì´ ${list.length}ê°œ`;
      }catch(e){
        statusEl.textContent = 'âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨';
      }
    }
    fetchCoffeeData();

    async function loadCafeData(){
      if(knuCafes.length) return;
      try{
        const res = await fetch(CAFE_JSON_URL,{cache:'no-store'});
        knuCafes = await res.json();
      }catch(e){
        console.error(e);
        alert('ì¹´í˜ ì§€ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    /* ===== ì„¤ë¬¸ ê°’ ===== */
    function getScore(name){
      return Number(document.querySelector(`input[name="${name}"]:checked`)?.value);
    }

    /* ===== íƒ€ì… ë¶„ë¥˜ ===== */
    const TYPE_CONFIG = {
      sour:{
        label:"ìƒí¼í˜•",
        desc:"ìƒí¼í•œ ì‚°ë¯¸ì™€ ë°ì€ í–¥ì„ ì‚¬ë‘í•˜ëŠ”, ìƒˆë¡œì›€ì— ëŒë¦¬ëŠ” ì»¤í”¼í˜• ì¸ê°„ì…ë‹ˆë‹¤.",
        note:"ìƒí¼í•œ ì‚°ë¯¸ê°€ ë“œëŸ¬ë‚˜ëŠ” ë¼ì´íŠ¸ ë¡œìŠ¤íŒ… ì›ë‘ì™€ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤. ì‹œíŠ¸ëŸ¬ìŠ¤ ê³„ì—´ í–¥ì´ ì‚´ì§ ëŠê»´ì§€ëŠ” ì•„ë©”ë¦¬ì¹´ë…¸ë¥¼ íŠ¹íˆ ì¢‹ì•„í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤."
      },
      nutty:{
        label:"ê³ ì†Œí˜•",
        desc:"ê³ ì†Œí•˜ê³  ë¶€ë“œëŸ¬ìš´ í–¥ì„ ì„ í˜¸í•˜ëŠ”, ì•ˆì •ì ì¸ ë£¨í‹´í˜• ì»¤í”¼ ì¸ê°„ì…ë‹ˆë‹¤.",
        note:"êµ¬ìˆ˜í•œ í’ë¯¸ì™€ ë„ˆíŠ¸ í–¥ì´ ìˆëŠ” ì›ë‘ì™€ ì˜ ë§ìŠµë‹ˆë‹¤. ë¼ë–¼ë‚˜ ê³ ì†Œí•œ ì•„ë©”ë¦¬ì¹´ë…¸ë¥¼ ìì£¼ ì°¾ëŠ” íƒ€ì…ì…ë‹ˆë‹¤."
      },
      bitter:{
        label:"ìŒ‰ì‚¬ë¦„í˜•",
        desc:"ë¬µì§í•˜ê³  ì§„í•œ ë§›ì„ ì¢‹ì•„í•˜ëŠ”, ì§‘ì¤‘ë ¥ ë†’ì€ ì»¤í”¼í˜• ì¸ê°„ì…ë‹ˆë‹¤.",
        note:"ë‹¤í¬ ë¡œìŠ¤íŒ…, ì—ìŠ¤í”„ë ˆì†Œ ë² ì´ìŠ¤ì˜ ì§„í•œ ì•„ë©”ë¦¬ì¹´ë…¸ì™€ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤. ê³µë¶€ë‚˜ ì‘ì—… ì „ì— ê°•í•œ í•œ ì”ì„ ì°¾ëŠ” ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤."
      },
      sourgoso:{
        label:"ë³µí•© ìƒí¼ê³ ì†Œí˜•",
        desc:"ìƒí¼í•¨ê³¼ ê³ ì†Œí•¨ì´ í•¨ê»˜ ëŠê»´ì§€ëŠ”, ë°¸ëŸ°ìŠ¤í˜• ì»¤í”¼ ì¸ê°„ì…ë‹ˆë‹¤.",
        note:"ìƒí¼í•œ ì²«ì¸ìƒ ë’¤ì— ê³ ì†Œí•œ ì—¬ìš´ì´ ë‚¨ëŠ” ë¸”ë Œë“œì™€ ì˜ ë§ìŠµë‹ˆë‹¤. ë©”ë‰´ ì„ íƒ í­ì´ ë„“ì€ í¸ì…ë‹ˆë‹¤."
      },
      blend:{
        label:"ë³µí•© ë¸”ë Œë“œí˜•",
        desc:"ì–´ëŠ í•œìª½ìœ¼ë¡œ ì¹˜ìš°ì¹˜ì§€ ì•Šì€, ì¡°í™”ë¡œìš´ ë³µí•© í’ë¯¸ë¥¼ ì„ í˜¸í•˜ëŠ” ì»¤í”¼í˜• ì¸ê°„ì…ë‹ˆë‹¤.",
        note:"ì—¬ëŸ¬ ë§›ì´ ê²¹ê²¹ì´ ìŒ“ì¸ ë¸”ë Œë“œ ì»¤í”¼ì™€ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤. ìƒí™©ì— ë”°ë¼ ë‹¤ì–‘í•œ ì¹´í˜ë¥¼ ì¦ê¸¸ ì¤€ë¹„ê°€ ëœ íƒ€ì…ì…ë‹ˆë‹¤."
      }
    };

    function classifyType(s,n,b){
      const max = Math.max(s,n,b);

      if (s >= max && s >= n+1 && s >= b+1) return 'sour';
      if (n >= max && n >= s+1 && n >= b+1) return 'nutty';
      if (b >= max && b >= s+1 && b >= n+1) return 'bitter';

      if (Math.abs(s-n) <= 1 && s >= 2 && n >= 2) return 'sourgoso';

      return 'blend';
    }

    function makeDots(score){
      return ("â— ".repeat(score) + "â—‹ ".repeat(4-score)).trim();
    }

    /* ===== TOP3 ê³„ì‚° ===== */
    function renderTop3(s,n,b){
      const ranked = coffeeList.map(c=>({
        name:c.name,
        score:Math.abs(s-c.acidity)+Math.abs(n-c.nutty)+Math.abs(b-c.bitter)
      }))
      .sort((a,b)=>a.score-b.score)
      .slice(0,3);

      const listEl = document.getElementById("top3List");
      listEl.innerHTML = ranked
        .map((c,i)=>`<li><strong>${i+1}ìœ„</strong> â€” ${c.name}</li>`)
        .join("");
    }

    /* ===== ê²°ê³¼ ë Œë”ë§ ===== */
    function renderResult(best, s, n, b){
      const typeKey = classifyType(s,n,b);
      const config = TYPE_CONFIG[typeKey];

      document.getElementById("resultType").textContent = config.label;
      document.getElementById("typeDesc").textContent  = config.desc;
      document.getElementById("bestCafeName").textContent = best.name;
      document.getElementById("noteText").textContent  = config.note;

      document.getElementById("dotAcid").textContent   = makeDots(s);
      document.getElementById("dotNutty").textContent  = makeDots(n);
      document.getElementById("dotBitter").textContent = makeDots(b);

      document.getElementById("txtAcid").textContent =
        s>=3 ? "ìƒí¼í•¨ì´ ëšœë ·í•œ í¸ì…ë‹ˆë‹¤." :
        s===2 ? "ìƒí¼í•¨ì´ ì€ì€í•˜ê²Œ ëŠê»´ì§‘ë‹ˆë‹¤." :
                "ìƒí¼í•¨ì€ ê±°ì˜ ëŠë¼ì§€ ëª»í•©ë‹ˆë‹¤.";

      document.getElementById("txtNutty").textContent =
        n>=3 ? "ê³ ì†Œí•¨ì´ í™•ì‹¤íˆ ëŠê»´ì§‘ë‹ˆë‹¤." :
        n===2 ? "ê³ ì†Œí•¨ì´ ì ë‹¹í•œ í¸ì…ë‹ˆë‹¤." :
                "ê³ ì†Œí•¨ì€ ì•½í•œ í¸ì…ë‹ˆë‹¤.";

      document.getElementById("txtBitter").textContent =
        b>=3 ? "ìŒ‰ì‚¬ë¦„í•¨ì´ ê°•í•˜ê²Œ ëŠê»´ì§‘ë‹ˆë‹¤." :
        b===2 ? "ì ë‹¹íˆ ìŒ‰ì‚¬ë¦„í•œ í¸ì…ë‹ˆë‹¤." :
                "ìŒ‰ì‚¬ë¦„í•¨ì€ ì•½í•œ í¸ì…ë‹ˆë‹¤.";

      renderTop3(s,n,b);

      document.getElementById("resultWrap").style.display = "flex";
      document.getElementById("resultActions").style.display = "flex";
      document.getElementById("top3Box").style.display = "none";
      document.getElementById("toggleTop3Btn").textContent = "â˜• ë¹„ìŠ·í•œ ì»¤í”¼ TOP3 ë³´ê¸°";

      document.getElementById("resultWrap").scrollIntoView({behavior:"smooth"});
    }

    /* ===== ê²°ê³¼ ê³„ì‚° ë²„íŠ¼ ===== */
    function calcResult(){
      const s = getScore('sour');
      const n = getScore('nutty');
      const b = getScore('bitter');

      if(!s || !n || !b){
        alert("ëª¨ë“  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      if(!coffeeList.length){
        alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      let best = null;
      let bestScore = Infinity;

      coffeeList.forEach(c=>{
        const dist = Math.abs(s-c.acidity)+Math.abs(n-c.nutty)+Math.abs(b-c.bitter);
        if(dist < bestScore){
          bestScore = dist;
          best = c;
        }
      });

      renderResult(best, s, n, b);
    }

    /* ===== TOP3 í† ê¸€ ë²„íŠ¼ ===== */
    const toggleBtn = document.getElementById("toggleTop3Btn");
    const top3Box = document.getElementById("top3Box");

    toggleBtn.addEventListener("click", ()=>{
      if(top3Box.style.display === "none" || top3Box.style.display === ""){
        top3Box.style.display = "block";
        toggleBtn.textContent = "â˜• ë¹„ìŠ·í•œ ì»¤í”¼ TOP3 ìˆ¨ê¸°ê¸°";
      }else{
        top3Box.style.display = "none";
        toggleBtn.textContent = "â˜• ë¹„ìŠ·í•œ ì»¤í”¼ TOP3 ë³´ê¸°";
      }
    });

    /* ===== ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥ (ì¸ìŠ¤íƒ€ìš©) ===== */
    document.getElementById("saveImageBtn").addEventListener("click", ()=>{
      const target = document.getElementById("resultCard");

      const prevScrollY = window.scrollY;
      window.scrollTo(0, target.offsetTop);

      html2canvas(target, {
        scale: 3,
        useCORS: true,
        backgroundColor: '#f4eee6',
        scrollY: -window.scrollY
      }).then(canvas=>{
        window.scrollTo(0, prevScrollY);

        const maxWidth = 1080;
        const ratio = maxWidth / canvas.width;

        const outCanvas = document.createElement("canvas");
        outCanvas.width  = maxWidth;
        outCanvas.height = canvas.height * ratio;

        const ctx = outCanvas.getContext("2d");
        ctx.drawImage(canvas, 0, 0, outCanvas.width, outCanvas.height);

        const link = document.createElement("a");
        link.download = "coffee-result.jpg";
        link.href = outCanvas.toDataURL("image/jpeg", 0.9);
        link.click();
      });
    });

    /* ===== ì§€ë„ ê¸°ëŠ¥ ===== */
    let knuMap = null;
    let mapInitialized = false;

    function tasteColor(taste){
      switch(taste){
        case 'ìƒí¼í˜•': return '#f39c12';
        case 'ê³ ì†Œí˜•': return '#a67c52';
        case 'ìŒ‰ì‚¬ë¦„í˜•': return '#6b3e26';
        case 'ë³µí•© ìƒí¼ê³ ì†Œí˜•': return '#d35400';
        case 'ë³µí•© ë¸”ë Œë“œí˜•': return '#d35400';
        default: return '#555555';
      }
    }

    async function initKnuMap(){
      if(mapInitialized){
        if(knuMap){
          resizeKnuMapSquare();
          knuMap.invalidateSize();
        }
        return;
      }

      await loadCafeData();
      resizeKnuMapSquare();

      knuMap = L.map('knuMap').setView([35.8880, 128.6100], 15);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                  {
                    attribution: '&copy; OSM &copy; CARTO',
                    maxZoom: 19
                  }
      ).addTo(knuMap);

      knuCafes.forEach(cafe=>{
        const color = tasteColor(cafe.taste);
        const marker = L.circleMarker([cafe.lat, cafe.lng], {
          radius: 8,
          color,
          fillColor: color,
          fillOpacity: 0.9
        }).addTo(knuMap);

        marker.bindPopup(`
          <strong>${cafe.name}</strong><br>
          ë§› íƒ€ì…: ${cafe.taste}<br>
          ê°€ê²©: ${cafe.price.toLocaleString()}ì›<br>
          ${cafe.note ?? ''}
        `);
      });

      mapInitialized = true;
      setTimeout(resizeKnuMapSquare, 150);
    }

    /* ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸° */
    function retry(){
      document.querySelectorAll("input[type=radio]").forEach(el=>el.checked=false);
      document.getElementById("resultWrap").style.display = "none";
      document.getElementById("resultActions").style.display = "none";
      window.scrollTo({top:0,behavior:"smooth"});
    }
  </script>
</body>
</html>
