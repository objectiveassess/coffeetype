<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>커피형 인간입니다 — 본인의 혈액 속 커피 유전자를 분석해드립니다.</title>

  <!-- 결과 카드 캡쳐용 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Leaflet (지도) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      /* 토스뱅크 느낌의 전체 톤 */
      --bg:#f3f4f6;          /* 페이지 전체 배경 (연한 회색) */
      --card:#ffffff;        /* 카드/박스 배경 */
      --muted:#6b7280;       /* 보조 텍스트 */
      --coffee-dark:#111827; /* 메인 텍스트 */
      --coffee-mid:#2563ff;  /* 포인트 컬러 (파란색) */
      --tap:44px;
      --radius:18px;
      --shadow:0 0 0 rgba(0,0,0,0);

      /* 결과 카드용 공통 변수 */
      --ink:#111827;
      --card-bg:#ffffff;
      --line:#e5e7eb;
      --accent:#2563ff;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:"Noto Sans KR",system-ui,-apple-system;
      background:var(--bg);
      color:var(--coffee-dark);
      padding:max(16px, env(safe-area-inset-top))
              max(16px, env(safe-area-inset-right))
              max(24px, env(safe-area-inset-bottom))
              max(16px, env(safe-area-inset-left));
      line-height:1.45;
    }

    .wrap{
      max-width:480px;
      margin:0 auto;
      padding:24px 20px 32px;
      background:#ffffff;
      border-radius:24px;
      border:1px solid #e5e7eb;
    }

    /* 공통 헤더 */
    header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    header img{
      width:44px;
      height:44px;
      border-radius:14px;
      object-fit:cover;
    }
    h1{
      font-size:18px;
      font-weight:800;
      color:var(--coffee-dark);
    }
    p.lead{
      margin-top:2px;
      color:var(--muted);
      font-size:13px;
    }

    button{
      background:var(--coffee-mid);
      border:none;
      color:white;
      padding:13px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      width:100%;
    }

    /* ===== 화면 전환용 ===== */
    .screen{display:none;}
    .screen.active{display:block;}

    /* 메인 메뉴 */
    .menu-card{
      margin-top:24px;
      background:var(--card);
      border-radius:20px;
      padding:20px 16px 18px;
      border:1px solid #e5e7eb;
      text-align:left;
    }
    .menu-title{
      font-size:20px;
      font-weight:800;
      margin-bottom:8px;
      color:var(--coffee-dark);
    }
    .menu-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:18px;
      line-height:1.6;
    }
    .menu-buttons{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:6px;
    }
    .menu-btn-main{
      background:var(--coffee-mid);
      color:#ffffff;
    }
    .menu-btn-sub{
      background:#111827;
      color:#ffffff;
    }
    .menu-btn-ghost{
      background:#f9fafb;
      color:#111827;
      border:1px solid #e5e7eb;
      border-radius:999px;
    }

    /* 설문 카드 */
    .card{
      background:var(--card);
      padding:16px;
      border-radius:12px;
      margin-top:16px;
      box-shadow:var(--shadow);
      border:1px solid #e5e7eb;
    }
    .question{margin-bottom:18px}
    .q-title{font-weight:800;font-size:15px;margin-bottom:8px}

    .likert-row{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
    }
    .likert{
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .likert-option{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      flex:1;
      min-width:0;
    }
    .edge-label{
      font-size:11px;
      font-weight:700;
      color:var(--coffee-dark);
      white-space:nowrap;
    }
    .dot{
      width:var(--tap);
      height:var(--tap);
      border-radius:50%;
      border:3px solid rgba(15,23,42,0.15);
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .18s;
      background:#fff;
    }
    .likert small{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .likert input{display:none}
    .likert input:checked + .dot{
      background:var(--coffee-mid);
      border-color:var(--coffee-mid);
    }
    .likert input:checked + .dot small{color:#fff}

    .actions{text-align:right;margin-top:8px}
    .status{margin-top:6px;font-size:13px;color:var(--muted)}

    /* ===== 결과 카드 ===== */
    .result-wrap{
      display:none;
      justify-content:center;
      margin-top:24px;
      margin-bottom:12px;
    }
    .result-container{
      width:100%;
      max-width:420px;
      display:flex;
      justify-content:center;
    }
    .result-card{
      width:100%;
      max-width:420px;
      height:auto;
      background:var(--card-bg);
      border-radius:16px;
      border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,0.06);
      padding:16px 16px 22px;
      display:flex;
      flex-direction:column;
      color:var(--ink);
      overflow:visible;
    }

    .report-header{
      display:flex;
      align-items:center;
      gap:10px;
      padding-bottom:8px;
      border-bottom:1px solid var(--line);
    }
    .brand-logo{
      width:42px;
      height:auto;
      flex-shrink:0;
    }
    .report-head-text{
      font-size:10px;
      letter-spacing:.02em;
      text-transform:none;
      color:rgba(0,0,0,0.55);
    }
    .report-head-title{
      font-weight:700;
      font-size:13px;
    }

    .main-box{
      margin-top:10px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.9);
    }
    .main-box h1{
      font-size:18px;
      margin-bottom:4px;
    }
    .subject{
      font-size:12px;
      margin-bottom:2px;
    }
    .type-line{
      font-size:13px;
      margin-bottom:6px;
    }
    .type-line strong{color:var(--accent);}
    .type-desc{
      font-size:11px;
      line-height:1.5;
      color:rgba(0,0,0,0.78);
    }

    .cafe-box{
      margin-top:8px;
      padding:10px 12px;
      border-radius:10px;
      border:1px dashed var(--accent);
      background:rgba(249,250,251,0.9);
      text-align:center;
      flex-shrink:0;
    }
    .cafe-label{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(0,0,0,0.55);
      margin-bottom:4px;
    }
    .cafe-name{
      min-height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      font-weight:800;
      color:var(--ink);
      margin-bottom:2px;
      text-align:center;
    }
    .cafe-note{
      font-size:11px;
      color:rgba(0,0,0,0.7);
    }

    .profile-box{
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.9);
      flex-shrink:0;
    }
    .profile-box h2{
      font-size:12px;
      margin-bottom:4px;
    }
    .profile-row{
      display:flex;
      align-items:center;
      font-size:11px;
      margin-bottom:3px;
    }
    .profile-row:last-child{margin-bottom:0}
    .profile-label{
      width:54px;
      font-weight:600;
    }
    .profile-dots{
      width:64px;
      font-family:monospace;
      font-size:11px;
    }
    .profile-text{
      flex:1;
      color:rgba(0,0,0,0.8);
    }

    .note-box{
      margin-top:6px;
      padding:8px 9px;
      border-radius:8px;
      border:1px solid var(--line);
      background:rgba(249,250,251,0.95);
      flex:1;
      display:flex;
      flex-direction:column;
    }
    .note-box h2{
      font-size:12px;
      margin-bottom:4px;
    }
    .note-box p{
      font-size:11px;
      line-height:1.5;
      color:rgba(0,0,0,0.82);
    }

    .top3-box{
      margin-top:6px;
      padding:8px 9px;
      border-radius:8px;
      border:1px dashed var(--line);
      background:rgba(255,255,255,0.9);
      font-size:11px;
      display:none;
    }
    .top3-box h3{
      font-size:11px;
      margin-bottom:4px;
    }
    .top3-box ul{
      margin-left:16px;
      margin-top:2px;
    }
    .top3-box li{
      margin-bottom:2px;
    }

    .report-footer{
      margin-top:14px;
      font-size:10px;
      text-align:center;
      color:rgba(0,0,0,0.55);
    }

    .result-actions{
      display:none;
      max-width:420px;
      margin:10px auto 0;
      flex-direction:column;
      gap:6px;
    }
    .result-actions button{
      width:100%;
      font-size:12px;
      border-radius:999px;
      padding:9px 8px;
      white-space:nowrap;
    }
    #toggleTop3Btn{background:#111827;}
    #saveImageBtn{background:#2563ff;}
    #retryBtn{background:#6b7280;}

    /* 지도 화면 */
    .map-card{
      margin-top:18px;
      background:var(--card);
      border-radius:20px;
      padding:16px 16px 18px;
      border:1px solid #e5e7eb;
    }
    .map-title{
      font-size:18px;
      font-weight:800;
      margin-bottom:4px;
    }
    .map-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:10px;
    }
    #knuMap{
      width:100%;
      height:420px;
      border-radius:12px;
      overflow:hidden;
    }
    .map-legend{
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
    }
    .legend-row{
      display:flex;
      align-items:center;
      gap:6px;
      margin-top:2px;
    }
    .legend-dot{
      width:10px;
      height:10px;
      border-radius:50%;
    }

    /* 아주 작은 화면용 */
    @media (max-width:360px){
      :root{ --tap:38px; }
      .likert{gap:6px;}
      .likert-option{gap:3px;}
      .result-card{padding:12px 12px 18px;}
      .main-box h1{font-size:17px;}
      .wrap{
        padding:20px 14px 28px;
        border-radius:0;
        border:none;
      }
      .menu-card{
        padding:18px 14px 16px;
      }
    }

    @media (max-width:560px){
      header{align-items:flex-start}
      button{width:100%}
      .result-card{border-radius:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 공통 헤더 -->
    <header>
      <img src="./logo.PNG" alt="커피 로고">
      <div>
        <h1>커피형 인간입니다.</h1>
        <p class="lead">본인의 혈액 속 커피 유전자를 분석해드립니다.</p>
      </div>
    </header>

    <!-- ===== 1. 메인 메뉴 화면 ===== -->
    <section id="menuScreen" class="screen active">
      <div class="menu-card">
        <div class="menu-title">오늘 마실 아이스 아메리카노를 골라볼까요</div>
        <p class="menu-sub">
          몇 가지 취향만 선택하면<br>
          지금 나에게 잘 맞는 아이스 아메리카노와<br>
          경북대 인근 카페를 함께 추천해 드립니다.
        </p>
        <div class="menu-buttons">
          <button class="menu-btn-main" onclick="showScreen('test')">
            나에게 맞는 아이스 아메리카노 테스트하기
          </button>
          <button class="menu-btn-sub" onclick="window.location.href='https://naver.me/FfBQjw53';">
            경북대 아아 맛 데이터 제보하기
          </button>
          <button class="menu-btn-ghost" onclick="showScreen('map')">
            경북대 아이스 아메리카노 지도 미리보기
          </button>
        </div>
      </div>
    </section>

    <!-- ===== 2. 테스트 화면 ===== -->
    <section id="testScreen" class="screen">
      <!-- 설문 카드 -->
      <div class="card">
        <div class="question">
          <div class="q-title">1) 상큼함(산미, 신맛)</div>
          <div class="likert-row">
            <div class="likert">
              <label class="likert-option">
                <span class="edge-label">좋아함</span>
                <input type="radio" name="sour" value="4">
                <div class="dot"><small>매우</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="sour" value="3">
                <div class="dot"><small>약간</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="sour" value="2">
                <div class="dot"><small>별로</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">싫어함</span>
                <input type="radio" name="sour" value="1">
                <div class="dot"><small>전혀</small></div>
              </label>
            </div>
          </div>
        </div>

        <div class="question">
          <div class="q-title">2) 고소함</div>
          <div class="likert-row">
            <div class="likert">
              <label class="likert-option">
                <span class="edge-label">좋아함</span>
                <input type="radio" name="nutty" value="4">
                <div class="dot"><small>매우</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="nutty" value="3">
                <div class="dot"><small>약간</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="nutty" value="2">
                <div class="dot"><small>별로</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">싫어함</span>
                <input type="radio" name="nutty" value="1">
                <div class="dot"><small>전혀</small></div>
              </label>
            </div>
          </div>
        </div>

        <div class="question">
          <div class="q-title">3) 쌉사름함(쓴맛)</div>
          <div class="likert-row">
            <div class="likert">
              <label class="likert-option">
                <span class="edge-label">좋아함</span>
                <input type="radio" name="bitter" value="4">
                <div class="dot"><small>매우</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="bitter" value="3">
                <div class="dot"><small>약간</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">&nbsp;</span>
                <input type="radio" name="bitter" value="2">
                <div class="dot"><small>별로</small></div>
              </label>
              <label class="likert-option">
                <span class="edge-label">싫어함</span>
                <input type="radio" name="bitter" value="1">
                <div class="dot"><small>전혀</small></div>
              </label>
            </div>
          </div>
        </div>

        <div id="status" class="status">데이터 불러오는 중…</div>

        <div class="actions">
          <button onclick="calcResult()">결과 보기</button>
        </div>
      </div>

      <!-- 결과 카드 -->
      <div class="result-wrap" id="resultWrap">
        <div class="result-container">
          <div class="result-card" id="resultCard">
            <header class="report-header">
              <img src="./logo.PNG" alt="커피 로고" class="brand-logo">
              <div>
                <div class="report-head-text">프로젝트 커피형 인간입니다.</div>
                <div class="report-head-title">커피 유전자 검사 결과서</div>
              </div>
            </header>

            <section class="main-box">
              <h1>커피형 인간입니다.</h1>
              <p class="subject">검사 대상: <span>커피 유전자 보유자</span>님</p>
              <p class="type-line">검사 결과 유형: <strong id="resultType">상큼형</strong></p>
              <p class="type-desc" id="typeDesc">
                상큼한 산미와 밝은 향을 사랑하는,
                새로움에 끌리는 커피형 인간입니다.
              </p>
            </section>

            <section class="cafe-box">
              <div class="cafe-label">RECOMMENDED CAFE</div>
              <div class="cafe-name" id="bestCafeName"></div>
              <p class="cafe-note">
                현재까지 수집된 커피 데이터 기준,  
                당신의 취향과 가장 잘 맞는 카페입니다.
              </p>
            </section>

            <section class="profile-box">
              <h2>맛 프로파일</h2>
              <div class="profile-row">
                <div class="profile-label">상큼함</div>
                <div class="profile-dots" id="dotAcid"></div>
                <div class="profile-text" id="txtAcid"></div>
              </div>
              <div class="profile-row">
                <div class="profile-label">고소함</div>
                <div class="profile-dots" id="dotNutty"></div>
                <div class="profile-text" id="txtNutty"></div>
              </div>
              <div class="profile-row">
                <div class="profile-label">쌉사름</div>
                <div class="profile-dots" id="dotBitter"></div>
                <div class="profile-text" id="txtBitter"></div>
              </div>
            </section>

            <section class="note-box">
              <h2>해석 메모</h2>
              <p id="noteText"></p>
            </section>

            <section class="top3-box" id="top3Box">
              <h3>비슷한 커피 TOP3</h3>
              <ul id="top3List"></ul>
            </section>

            <div class="report-footer">
              본 결과는 ‘커피형 인간입니다.’ 프로젝트의 취향 데이터를 기반으로 산출된 비공식 검사입니다.<br>
              커피형 인간입니다. · coffeeperson.co.kr
            </div>
          </div>
        </div>
      </div>

      <!-- 결과 하단 버튼들 -->
      <div class="result-actions" id="resultActions">
        <button id="toggleTop3Btn">비슷한 커피 TOP3 보기</button>
        <button id="saveImageBtn">결과 이미지 저장하기</button>
        <button id="retryBtn" onclick="retry()">다시 검사하기</button>
        <button class="menu-btn-ghost" onclick="showScreen('menu')">메뉴로 돌아가기</button>
      </div>
    </section>

    <!-- ===== 3. 경북대 아아 지도 화면 ===== -->
    <section id="mapScreen" class="screen">
      <div class="map-card">
        <div class="map-title">경북대 아이스 아메리카노 지도(개발중)</div>
        <p class="map-sub">
          경북대 인근에서 아아를 판매하는 카페들을 하나씩 모으는 중입니다.<br>
          점 색깔은 카페의 대표 아아 맛 타입을 의미해요.
        </p>
        <div id="knuMap"></div>
        <div class="map-legend">
          <div class="legend-row">
            <div class="legend-dot" style="background:#f39c12;"></div> 상큼형
          </div>
          <div class="legend-row">
            <div class="legend-dot" style="background:#a67c52;"></div> 고소형
          </div>
          <div class="legend-row">
            <div class="legend-dot" style="background:#6b3e26;"></div> 쌉사름형
          </div>
          <div class="legend-row">
            <div class="legend-dot" style="background:#d35400;"></div> 복합 상큼고소형 / 블렌드형
          </div>
        </div>
        <div style="margin-top:10px;text-align:right;">
          <button class="menu-btn-ghost" onclick="showScreen('menu')">메뉴로 돌아가기</button>
        </div>
      </div>
    </section>

  </div>

  <script>
    /* ===== 화면 전환 ===== */
    function showScreen(name){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      if(name === 'menu'){
        document.getElementById('menuScreen').classList.add('active');
        window.scrollTo({top:0,behavior:'smooth'});
      }else if(name === 'test'){
        document.getElementById('testScreen').classList.add('active');
        window.scrollTo({top:0,behavior:'smooth'});
      }else if(name === 'map'){
        document.getElementById('mapScreen').classList.add('active');
        initKnuMap();
        setTimeout(()=>{ if(knuMap) knuMap.invalidateSize(); }, 200);
      }
    }

    /* ===== 데이터 로딩 ===== */
    const JSON_URL = './coffee-data.json?v=10';
    /* 깃허브 raw 에 있는 카페 데이터로 고정 */
    const CAFE_JSON_URL = 'https://raw.githubusercontent.com/objectiveassess/coffeetype/main/knu-cafes.json';

    let coffeeList = [];
    let knuCafes = [];
    let lastFetched = null;
    const statusEl = document.getElementById('status');

    async function fetchCoffeeData(){
      try{
        const res = await fetch(JSON_URL,{cache:'no-store'});
        const list = await res.json();
        coffeeList = list;
        lastFetched = new Date();
        statusEl.textContent = `등록된 경북대 인근 카페 데이터 총 ${list.length}개`;
      }catch(e){
        statusEl.textContent = '⚠️ 데이터 로드 실패';
      }
    }
    fetchCoffeeData();

    async function loadCafeData(){
      if(knuCafes.length) return;
      try{
        const res = await fetch(CAFE_JSON_URL,{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        knuCafes = await res.json();
      }catch(e){
        console.error(e);
        alert('카페 지도 데이터를 불러오지 못했습니다.');
      }
    }

    /* ===== 설문 값 ===== */
    function getScore(name){
      return Number(document.querySelector(`input[name="${name}"]:checked`)?.value);
    }

    /* ===== 타입 분류 ===== */
    const TYPE_CONFIG = {
      sour:{
        label:"상큼형",
        desc:"상큼한 산미와 밝은 향을 사랑하는, 새로움에 끌리는 커피형 인간입니다.",
        note:"상큼한 산미가 드러나는 라이트 로스팅 원두와 잘 어울립니다. 시트러스 계열 향이 살짝 느껴지는 아메리카노를 특히 좋아할 가능성이 높습니다."
      },
      nutty:{
        label:"고소형",
        desc:"고소하고 부드러운 향을 선호하는, 안정적인 루틴형 커피 인간입니다.",
        note:"구수한 풍미와 너트 향이 있는 원두와 잘 맞습니다. 라떼나 고소한 아메리카노를 자주 찾는 타입입니다."
      },
      bitter:{
        label:"쌉사름형",
        desc:"묵직하고 진한 맛을 좋아하는, 집중력 높은 커피형 인간입니다.",
        note:"다크 로스팅, 에스프레소 베이스의 진한 아메리카노와 잘 어울립니다. 공부나 작업 전에 강한 한 잔을 찾는 스타일입니다."
      },
      sourgoso:{
        label:"복합 상큼고소형",
        desc:"상큼함과 고소함이 함께 느껴지는, 밸런스형 커피 인간입니다.",
        note:"상큼한 첫인상 뒤에 고소한 여운이 남는 블렌드와 잘 맞습니다. 메뉴 선택 폭이 넓은 편입니다."
      },
      blend:{
        label:"복합 블렌드형",
        desc:"어느 한쪽으로 치우치지 않은, 조화로운 복합 풍미를 선호하는 커피형 인간입니다.",
        note:"여러 맛이 겹겹이 쌓인 블렌드 커피와 잘 어울립니다. 상황에 따라 다양한 카페를 즐길 준비가 된 타입입니다."
      }
    };

    function classifyType(s,n,b){
      const max = Math.max(s,n,b);

      if (s >= max && s >= n+1 && s >= b+1) return 'sour';
      if (n >= max && n >= s+1 && n >= b+1) return 'nutty';
      if (b >= max && b >= s+1 && b >= n+1) return 'bitter';

      if (Math.abs(s-n) <= 1 && s >= 2 && n >= 2) return 'sourgoso';

      return 'blend';
    }

    function makeDots(score){
      return ("● ".repeat(score) + "○ ".repeat(4-score)).trim();
    }

    /* ===== TOP3 계산 ===== */
    function renderTop3(s,n,b){
      const ranked = coffeeList.map(c=>({
        name:c.name,
        score:Math.abs(s-c.acidity)+Math.abs(n-c.nutty)+Math.abs(b-c.bitter)
      }))
      .sort((a,b)=>a.score-b.score)
      .slice(0,3);

      const listEl = document.getElementById("top3List");
      listEl.innerHTML = ranked
        .map((c,i)=>`<li><strong>${i+1}위</strong> — ${c.name}</li>`)
        .join("");
    }

    /* ===== 결과 렌더링 ===== */
    function renderResult(best, s, n, b){
      const typeKey = classifyType(s,n,b);
      const config = TYPE_CONFIG[typeKey];

      document.getElementById("resultType").textContent = config.label;
      document.getElementById("typeDesc").textContent  = config.desc;
      document.getElementById("bestCafeName").textContent = best.name;
      document.getElementById("noteText").textContent  = config.note;

      document.getElementById("dotAcid").textContent   = makeDots(s);
      document.getElementById("dotNutty").textContent  = makeDots(n);
      document.getElementById("dotBitter").textContent = makeDots(b);

      document.getElementById("txtAcid").textContent =
        s>=3 ? "상큼함이 뚜렷한 편입니다." :
        s===2 ? "상큼함이 은은하게 느껴집니다." :
                "상큼함은 거의 느끼지 못합니다.";

      document.getElementById("txtNutty").textContent =
        n>=3 ? "고소함이 확실히 느껴집니다." :
        n===2 ? "고소함이 적당한 편입니다." :
                "고소함은 약한 편입니다.";

      document.getElementById("txtBitter").textContent =
        b>=3 ? "쌉사름함이 강하게 느껴집니다." :
        b===2 ? "적당히 쌉사름한 편입니다." :
                "쌉사름함은 약한 편입니다.";

      renderTop3(s,n,b);

      document.getElementById("resultWrap").style.display = "flex";
      document.getElementById("resultActions").style.display = "flex";
      document.getElementById("top3Box").style.display = "none";
      document.getElementById("toggleTop3Btn").textContent = "비슷한 커피 TOP3 보기";

      document.getElementById("resultWrap").scrollIntoView({behavior:"smooth"});
    }

    /* ===== 결과 계산 버튼 ===== */
    function calcResult(){
      const s = getScore('sour');
      const n = getScore('nutty');
      const b = getScore('bitter');

      if(!s || !n || !b){
        alert("모든 항목을 선택하세요.");
        return;
      }
      if(!coffeeList.length){
        alert("데이터가 없습니다.");
        return;
      }

      let best = null;
      let bestScore = Infinity;

      coffeeList.forEach(c=>{
        const dist = Math.abs(s-c.acidity)+Math.abs(n-c.nutty)+Math.abs(b-c.bitter);
        if(dist < bestScore){
          bestScore = dist;
          best = c;
        }
      });

      renderResult(best, s, n, b);
    }

    /* ===== TOP3 토글 버튼 ===== */
    const toggleBtn = document.getElementById("toggleTop3Btn");
    const top3Box = document.getElementById("top3Box");

    toggleBtn.addEventListener("click", ()=>{
      if(top3Box.style.display === "none" || top3Box.style.display === ""){
        top3Box.style.display = "block";
        toggleBtn.textContent = "비슷한 커피 TOP3 숨기기";
      }else{
        top3Box.style.display = "none";
        toggleBtn.textContent = "비슷한 커피 TOP3 보기";
      }
    });

    /* ===== 결과 이미지 저장 (인스타용) ===== */
    document.getElementById("saveImageBtn").addEventListener("click", ()=>{
      const target = document.getElementById("resultCard");

      const prevScrollY = window.scrollY;
      window.scrollTo(0, target.offsetTop);

      html2canvas(target, {
        scale: 3,
        useCORS: true,
        backgroundColor: '#f3f4f6',
        scrollY: -window.scrollY
      }).then(canvas=>{
        window.scrollTo(0, prevScrollY);

        const maxWidth = 1080;
        const ratio = maxWidth / canvas.width;

        const outCanvas = document.createElement("canvas");
        outCanvas.width  = maxWidth;
        outCanvas.height = canvas.height * ratio;

        const ctx = outCanvas.getContext("2d");
        ctx.drawImage(canvas, 0, 0, outCanvas.width, outCanvas.height);

        const link = document.createElement("a");
        link.download = "coffee-result.jpg";
        link.href = outCanvas.toDataURL("image/jpeg", 0.9);
        link.click();
      });
    });

    /* ===== 지도 기능 ===== */
    let knuMap = null;
    let mapInitialized = false;

    function tasteColor(taste){
      switch(taste){
        case '상큼형': return '#f39c12';
        case '고소형': return '#a67c52';
        case '쌉사름형': return '#6b3e26';
        case '복합 상큼고소형': return '#d35400';
        case '복합 블렌드형': return '#d35400';
        default: return '#555555';
      }
    }

    async function initKnuMap(){
      if(mapInitialized) return;

      await loadCafeData();

      if(!knuCafes.length){
        return;
      }

      knuMap = L.map('knuMap').setView([35.8880, 128.6100], 15);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                  {
                    attribution: '&copy; OSM &copy; CARTO',
                    maxZoom: 19
                  }
      ).addTo(knuMap);
      knuCafes.forEach(cafe=>{
        const color = tasteColor(cafe.taste);
        const marker = L.circleMarker([cafe.lat, cafe.lng], {
          radius: 8,
          color,
          fillColor: color,
          fillOpacity: 0.9
        }).addTo(knuMap);

        marker.bindPopup(`
          <strong>${cafe.name}</strong><br>
          맛 타입: ${cafe.taste}<br>
          가격: ${cafe.price.toLocaleString()}원<br>
          ${cafe.note ?? ''}
        `);
      });

      mapInitialized = true;
    }

    /* 다시 검사하기 */
    function retry(){
      document.querySelectorAll("input[type=radio]").forEach(el=>el.checked=false);
      document.getElementById("resultWrap").style.display = "none";
      document.getElementById("resultActions").style.display = "none";
      window.scrollTo({top:0,behavior:"smooth"});
    }
  </script>
</body>
</html>
